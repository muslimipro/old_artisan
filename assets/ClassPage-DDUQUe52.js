import{T as Le}from"./index-kWBAI4Kf.js";import{s as Re}from"./index-Bc7j_4YG.js";import{s as je}from"./index-B7pmn30v.js";import{B as Be,s as me,b as Ge,u as Ue,a1 as Ae,a as Me,r as c,f as Ee,e as qe,x as z,g as He,E as Oe,o as n,p as y,D as i,j as r,t as d,i as b,q as w,k as J,h as o,n as G,c as p,l as L,F as x,y as U,C as Ye,v as Ke,aH as Je,w as Qe,L as We}from"./index-BSlsk6NZ.js";import{s as Xe,a as Ze}from"./index-R6QGRCxq.js";import{a as es,b as ss}from"./index-Ab8ONmCb.js";import{s as ts}from"./index-BrBUlovc.js";import{s as as}from"./index-rXGK9iRz.js";import{R as os,m as ls}from"./mapRouteFromDto-DuQ--sH7.js";import{A as pe}from"./lessonType-v5Tmr0TL.js";import{C as T}from"./classApi-BRGmf9Ah.js";import{m as ns}from"./mapStudentFromDto-D4MSietx.js";import{m as rs}from"./mapClassFromDto-BHXsJaNm.js";import{S as is}from"./schoolApi-B9M5ltOJ.js";import"./index-DQ5VWK02.js";import"./index-BHYpWwOD.js";import"./index-c8KM_6NZ.js";import"./index-DR0tTCB4.js";import"./index-C6RMKmKq.js";import"./index-DZEnUuD4.js";import"./index-xZNHaCtS.js";import"./index-Bg_UjTW2.js";import"./index-ae_WsV7Y.js";import"./mapLessonFromDto-D3cEBYeg.js";import"./mapUnitFromDto-DVWJHO4f.js";import"./transformUnitDtosToPages-hsgZNhAG.js";var us=Be.extend({name:"columngroup"}),cs={name:"BaseColumnGroup",extends:me,props:{type:{type:String,default:null}},style:us,provide:function(){return{$pcColumnGroup:this,$parentInstance:this}}},ds={name:"ColumnGroup",extends:cs,inheritAttrs:!1,inject:["$columnGroups"],mounted:function(){var l;(l=this.$columnGroups)===null||l===void 0||l.add(this.$)},unmounted:function(){var l;(l=this.$columnGroups)===null||l===void 0||l.delete(this.$)},render:function(){return null}},ps={name:"Row",extends:me,inject:["$rows"],mounted:function(){var l;(l=this.$rows)===null||l===void 0||l.add(this.$)},unmounted:function(){var l;(l=this.$rows)===null||l===void 0||l.delete(this.$)},render:function(){return null}};const ms={class:"flex flex-col items-start px-8 pb-4 gap-4"},fs={class:"flex items-center justify-between gap-2 w-full"},vs={class:"flex flex-col gap-2"},hs={class:"text-3xl"},gs={class:"text-2xl"},ys={class:"text-sm"},_s={class:"flex items-center self-end"},bs={class:"text-xl"},$s={class:"text-gray-500"},ws={class:"flex items-center"},xs={class:"flex-grow flex gap-2 items-center"},Cs={class:"flex gap-2 items-center justify-between w-full"},Ss={class:"flex-grow"},ks={class:"w-full text-center"},Ts={class:"w-full text-center"},Is=["onClick"],Vs={class:"flex flex-col"},Ns={key:0,class:"pi pi-check",style:{"font-size":"10px"}},Fs={key:1,class:"pi pi-ellipsis-h",style:{"font-size":"10px"}},Ds={class:"text-right"},Ps={class:"flex justify-center text-[124px]"},zs={class:"flex justify-between items-center mb-8"},Ls={class:"flex justify-end gap-2"},ut=Ge({__name:"ClassPage",setup(C){const l=Ue(),A=Ae(),_=Ye(),Q=Ke(),{t:m}=Me(),W=c(),I=c();(()=>{I.value={global:{value:null,matchMode:Je.CONTAINS}}})();const fe=()=>{W.value.exportCSV()},ve=Ee(),{userInfo:S}=qe(ve),M=c(!1),k=c(null),V=c([]),h=c([]),g=c(["learn","practice"]),N=z(()=>{if(h.value.length==0||g.value.length==0)return[];const e=new Set(h.value),s=h.value.length>0,a=new Set(g.value),f=g.value.length>0&&g.value.length<pe.length;return V.value.filter($=>!s||e.has($.id)).map($=>({...$,lessons:$.lessons.filter(Y=>!f||a.has(Y.lessonType))}))}),X=z(()=>{const e={};for(const s of N.value)e[s.id]=s.lessons.length;return e}),Z=z(()=>{const e={};for(const s of N.value){e[s.id]={};for(const a of s.levels)e[s.id][a.id]=0;for(const a of s.lessons)a.stage=="published"&&(e[s.id][a.levelId]=(e[s.id][a.levelId]??0)+1)}return e}),R=z(()=>{const e=[];for(const s of N.value)for(const a of s.levels)for(const f of s.lessons.filter($=>$.levelId===a.id))f.stage=="published"&&e.push({routeId:s.id,levelId:a.id,lessonId:f.id,lessonType:f.lessonType,lessonName:f.name});return e}),he=z(()=>R.value.length);function ge(e){let s=0;for(const a of R.value)F(e,a.lessonId)>=100&&(s+=1);return s}function E(e){return e==="learn"?"bg-primary400":e==="practice"?"bg-purple400":e==="module"?"bg-warning400":"bg-blue400"}async function q(){var e;try{const{data:s}=await T.getClass(Number(_.params.id));k.value=rs(s),((e=S.value)==null?void 0:e.user_type)=="school_manager"&&(await Ie(),P.value=O.value.find(a=>{var f;return a.teacher_id==((f=k.value)==null?void 0:f.creator)})??null)}catch(s){console.log(s)}}async function ye(){try{const{data:e}=await os.getRoutes();V.value=(e==null?void 0:e.map(ls))??[]}catch(e){console.log(e)}}async function _e(){try{const{data:e}=await T.getClassStudentsProgress(Number(_.params.id),h.value,g.value),s={};for(const a of e.progress_data??[])s[a.student_id]||(s[a.student_id]={}),s[a.student_id][a.lesson_id]=a.completed?100:a.student_progress;ee.value=s}catch(e){console.log(e)}}const ee=c({});function F(e,s){var a;return((a=ee.value[e])==null?void 0:a[s])??0}function be(e){return e>=100?"bg-primary400":e>0?"bg-warning400":"bg-neutral100"}const H=c(!1),se=c();async function te(e){try{H.value=!0;const{data:s}=await T.getClassStudents(e);se.value=(s==null?void 0:s.map(ns))??[]}catch(s){l.add({severity:"error",summary:s.response.data.error,life:2e3})}finally{H.value=!1}}He(async()=>{await q(),await ye(),await te(Number(_.params.id)),V.value.length>0&&(h.value=[V.value[0].id])}),Oe([h,g],async()=>{h.value.length==0||g.value.length==0||await _e()});function $e(){A.require({message:m("pages.teacher.areYouSureDeleteClass"),header:m("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:m("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:m("pages.teacher.delete"),severity:"danger"},accept:()=>{we(Number(_.params.id))}})}async function we(e){try{const{data:s}=await T.deleteClass(e);Q.go(-1),l.add({severity:"success",summary:s.message,life:2e3})}catch(s){l.add({severity:"error",summary:s.response.data.error,detail:s,life:2e3})}}function xe(e){A.require({message:m("pages.teacher.areYouSureExpelStudent"),header:m("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:m("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:m("pages.teacher.expel"),severity:"danger"},accept:()=>{Ce(e)}})}async function Ce(e){try{const{data:s}=await T.expelStudentFromClass(Number(_.params.id),e);await te(Number(_.params.id)),l.add({severity:"success",summary:s.message,life:2e3})}catch(s){l.add({severity:"error",summary:s.response.data.error,detail:s,life:2e3})}}const j=c(!1),D=c(!1),P=c(null);async function Se(){if(P.value){j.value=!0;try{await T.assignTeacherToClass(Number(_.params.id),P.value.teacher_id),await q()}catch(e){console.log(e)}finally{j.value=!1,D.value=!1}}}function ke(){A.require({message:m("pages.school.confirmDeleteTeacher"),header:m("pages.school.confirmHeader"),icon:"pi pi-exclamation-triangle",rejectProps:{label:m("pages.school.confirmCancel"),severity:"secondary",outlined:!0},acceptProps:{label:m("pages.school.confirmDeleteBtn"),severity:"danger"},accept:()=>{Te()}})}async function Te(){try{const{data:e}=await T.assignTeacherToClass(Number(_.params.id));await q(),l.add({severity:"success",summary:e.message,life:2e3})}catch(e){l.add({severity:"error",summary:e.response.data.error,detail:e,life:2e3})}}const O=c([]);async function Ie(){const{data:e}=await is.getTeachers();O.value=e??[]}return(e,s)=>{const a=Qe,f=as,$=es,Y=ts,Ve=ss,v=Xe,K=ps,Ne=ds,Fe=Ze,ae=We,De=je,Pe=Re,B=Le;return n(),y(Pe,{class:"flex-grow flex flex-col gap-2"},{default:i(()=>{var oe,le,ne,re,ie,ue,ce,de;return[r("div",ms,[r("div",fs,[r("div",vs,[r("div",hs,d((oe=k.value)==null?void 0:oe.schoolName),1),r("div",gs,d((le=k.value)==null?void 0:le.name),1),r("div",ys,d(e.$t("pages.teacher.since"))+" "+d((ne=k.value)==null?void 0:ne.createdTime),1)]),["teacher","school_manager"].includes(((re=b(S))==null?void 0:re.user_type)??"")?(n(),y(a,{key:0,icon:"pi pi-hashtag",label:e.$t("pages.teacher.classCode"),severity:"info",onClick:s[0]||(s[0]=t=>M.value=!0)},null,8,["label"])):w("",!0)]),r("div",_s,[r("div",bs,[r("span",$s,d(e.$t("pages.teacher.teacher")),1),J(" "+d((ie=k.value)==null?void 0:ie.creatorName),1)]),((ue=b(S))==null?void 0:ue.user_type)=="school_manager"?(n(),y(a,{key:0,icon:"pi pi-pencil",severity:"info",variant:"text",rounded:"",onClick:s[1]||(s[1]=t=>D.value=!0)})):w("",!0),((ce=b(S))==null?void 0:ce.user_type)=="school_manager"?(n(),y(a,{key:1,icon:"pi pi-trash",severity:"danger",variant:"text",rounded:"",onClick:ke})):w("",!0)]),o(Fe,{ref_key:"dt",ref:W,filters:I.value,"onUpdate:filters":s[5]||(s[5]=t=>I.value=t),value:se.value,dataKey:"id",loading:H.value,scrollable:"",globalFilterFields:["name","email"],class:"overflow-hidden w-full",paginator:"",rows:25,rowsPerPageOptions:[5,10,25],groupHeader:!0,showGridlines:""},{header:i(()=>[r("div",ws,[r("div",xs,[o(f,{class:"min-w-[220px]",options:V.value.map(t=>({label:t.name,value:t.id})),optionLabel:"label",invalid:h.value.length===0,optionValue:"value",display:"chip",modelValue:h.value,"onUpdate:modelValue":s[2]||(s[2]=t=>h.value=t),placeholder:e.$t("courses")},null,8,["options","invalid","modelValue","placeholder"]),o(f,{class:"min-w-[220px]",options:b(pe),optionLabel:t=>t,optionValue:t=>t,display:"chip",modelValue:g.value,"onUpdate:modelValue":s[3]||(s[3]=t=>g.value=t),placeholder:e.$t("lessonType"),invalid:g.value.length===0},{option:i(({option:t})=>[r("div",Cs,[r("div",Ss,d(t.charAt(0).toUpperCase()+t.slice(1)),1),r("div",{class:G(["w-3 h-3 rounded-full mx-auto",E(t)])},null,2)])]),_:1},8,["options","optionLabel","optionValue","modelValue","placeholder","invalid"])]),o(a,{label:e.$t("export"),icon:"pi pi-upload",severity:"info",variant:"outlined",class:"mr-2",onClick:fe},null,8,["label"]),o(Ve,null,{default:i(()=>[o($,null,{default:i(()=>s[10]||(s[10]=[r("i",{class:"pi pi-search"},null,-1)])),_:1}),o(Y,{modelValue:I.value.global.value,"onUpdate:modelValue":s[4]||(s[4]=t=>I.value.global.value=t),placeholder:e.$t("pages.teacher.search")},null,8,["modelValue","placeholder"])]),_:1})])]),empty:i(()=>[J(d(e.$t("pages.teacher.noStudentsFound")),1)]),loading:i(()=>[J(d(e.$t("pages.teacher.loadingStudents")),1)]),default:i(()=>[o(Ne,{type:"header"},{default:i(()=>[o(K,null,{default:i(()=>[o(v,{header:e.$t("lessons"),rowspan:2,colspan:1,frozen:!0,alignFrozen:"left"},null,8,["header"]),(n(!0),p(x,null,L(N.value,t=>(n(),p(x,{key:t.id},[X.value[t.id]>0?(n(),y(v,{key:0,colspan:X.value[t.id]},{header:i(()=>[r("div",ks,d(t.name),1)]),_:2},1032,["colspan"])):w("",!0)],64))),128)),o(v,{header:"",rowspan:2,colspan:2})]),_:1}),o(K,null,{default:i(()=>[(n(!0),p(x,null,L(N.value,t=>(n(),p(x,{key:t.id},[(n(!0),p(x,null,L(t.levels,u=>(n(),p(x,{key:u.id},[Z.value[t.id][u.id]>0?(n(),y(v,{key:0,colspan:Z.value[t.id][u.id]},{header:i(()=>[r("div",Ts,d(u.name),1)]),_:2},1032,["colspan"])):w("",!0)],64))),128))],64))),128))]),_:1}),o(K,null,{default:i(()=>[o(v,{header:e.$t("pages.teacher.name"),frozen:!0,alignFrozen:"left",sortable:"",field:"name"},null,8,["header"]),(n(!0),p(x,null,L(R.value,t=>(n(),y(v,{key:t.lessonId,field:t.lessonId.toString()},{header:i(()=>{var u;return[["super_admin","admin-viewer","school_manager","teacher"].includes(((u=b(S))==null?void 0:u.user_type)??"")?U((n(),p("i",{key:0,class:G(["pi pi-external-link mx-auto cursor-pointer hover:opacity-80 transition-opacity text-sm",E(t.lessonType)]),onClick:ze=>b(Q).push(`/teacher/class/${b(_).params.id}/lesson/${t.lessonId}`)},null,10,Is)),[[B,{value:t.lessonName.toString()},void 0,{top:!0}]]):U((n(),p("div",{key:1,class:G(["w-3 h-3 rounded-full mx-auto",E(t.lessonType)])},null,2)),[[B,{value:t.lessonName.toString()},void 0,{top:!0}]])]}),_:2},1032,["field"]))),128)),o(v,{header:e.$t("pages.teacher.xp"),field:"xp",frozen:!0,alignFrozen:"right"},null,8,["header"]),o(v,{header:""})]),_:1})]),_:1}),o(v,{field:"name",sortable:"",frozen:!0,alignFrozen:"left"},{body:i(({data:t})=>[r("div",Vs,[r("div",null,d(`${t.name.length>0?t.name:t.email}`),1)])]),_:1}),(n(!0),p(x,null,L(R.value,t=>(n(),y(v,{key:t.lessonId,field:t.lessonId.toString()},{body:i(({data:u})=>[U((n(),p("div",{class:G(["w-4 h-4 p-1 rounded-full mx-auto flex items-center justify-center text-white",be(F(u.id,t.lessonId))])},[F(u.id,t.lessonId)>=100?(n(),p("i",Ns)):F(u.id,t.lessonId)>0?(n(),p("i",Fs)):w("",!0)],2)),[[B,{value:F(u.id,t.lessonId).toString()+"%"},void 0,{top:!0}]])]),_:2},1032,["field"]))),128)),o(v,{field:"xp",frozen:!0,alignFrozen:"right"},{body:i(({data:t})=>[r("div",Ds,d(`${ge(t.id)}/${he.value}`),1)]),_:1}),o(v,{exportable:!1},{body:i(({data:t})=>{var u;return[["teacher","school_manager"].includes(((u=b(S))==null?void 0:u.user_type)??"")?U((n(),y(a,{key:0,icon:"pi pi-user-minus",rounded:"",variant:"text",severity:"danger",onClick:ze=>xe(t.id)},null,8,["onClick"])),[[B,e.$t("pages.teacher.expelFromClass")]]):w("",!0)]}),_:1})]),_:1},8,["filters","value","loading"]),["teacher","school_manager"].includes(((de=b(S))==null?void 0:de.user_type)??"")?(n(),y(a,{key:0,icon:"pi pi-trash",label:e.$t("pages.teacher.removeClass"),severity:"danger",onClick:$e,class:"self-end"},null,8,["label"])):w("",!0)]),o(ae,{visible:M.value,"onUpdate:visible":s[6]||(s[6]=t=>M.value=t),modal:"",header:e.$t("pages.teacher.classCode")},{default:i(()=>{var t;return[r("div",Ps,d((t=k.value)==null?void 0:t.code),1)]}),_:1},8,["visible","header"]),o(ae,{visible:D.value,"onUpdate:visible":s[9]||(s[9]=t=>D.value=t),modal:"",header:e.$t("pages.school.assignTeacher"),closable:!1},{default:i(()=>[r("div",zs,[o(De,{modelValue:P.value,"onUpdate:modelValue":s[7]||(s[7]=t=>P.value=t),options:O.value,"option-label":"email",placeholder:e.$t("pages.school.selectTeacher")},null,8,["modelValue","options","placeholder"])]),r("div",Ls,[o(a,{type:"button",label:e.$t("pages.school.cancel"),severity:"secondary",onClick:s[8]||(s[8]=t=>D.value=!1)},null,8,["label"]),o(a,{type:"button",label:e.$t("pages.school.assign"),onClick:Se,loading:j.value,disabled:j.value},null,8,["label","loading","disabled"])])]),_:1},8,["visible","header"])]}),_:1})}}});export{ut as default};
