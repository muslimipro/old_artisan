import{T as Le}from"./index-BbV5txCL.js";import{s as Pe}from"./index-c6iTNCJH.js";import{s as ze}from"./index-J_wi4mxH.js";import{B as Be,s as _e,b as Ge,u as Ue,a1 as Ae,a as Ee,r as m,f as Me,e as Oe,x as A,g as qe,E as He,o as n,p as b,D as i,j as r,t as f,i as C,q as x,k as te,h as o,n as q,c as v,l as E,F as S,y as H,C as Ye,v as Ke,aH as Je,w as Qe,L as We}from"./index-BwcPjnJP.js";import{s as Xe,a as Ze}from"./index-P7_tGZCZ.js";import{a as es,b as ss}from"./index-Bht399_o.js";import{s as ts}from"./index-X0HA0JnL.js";import{s as as}from"./index-BlHbwift.js";import{R as os,m as ls}from"./mapRouteFromDto-10Zsm-pb.js";import{A as ye}from"./lessonType-v5Tmr0TL.js";import{C as V,m as ns}from"./mapClassFromDto-6vecsJoI.js";import{m as rs}from"./mapStudentFromDto-D4MSietx.js";import{S as is}from"./schoolApi-Ba4b9q6V.js";import"./index-CXxu4Mjq.js";import"./index-DH5eiR2q.js";import"./index-D9kQDm6b.js";import"./index-w-z7np8T.js";import"./index-DqtVKoVZ.js";import"./index-C691Vja9.js";import"./index-B4dxx41c.js";import"./index-Bqa5yC9A.js";import"./index-D2oMMRm7.js";import"./mapLessonFromDto-D3cEBYeg.js";import"./mapUnitFromDto-DVWJHO4f.js";import"./transformUnitDtosToPages-hsgZNhAG.js";var us=Be.extend({name:"columngroup"}),cs={name:"BaseColumnGroup",extends:_e,props:{type:{type:String,default:null}},style:us,provide:function(){return{$pcColumnGroup:this,$parentInstance:this}}},ds={name:"ColumnGroup",extends:cs,inheritAttrs:!1,inject:["$columnGroups"],mounted:function(){var l;(l=this.$columnGroups)===null||l===void 0||l.add(this.$)},unmounted:function(){var l;(l=this.$columnGroups)===null||l===void 0||l.delete(this.$)},render:function(){return null}},ps={name:"Row",extends:_e,inject:["$rows"],mounted:function(){var l;(l=this.$rows)===null||l===void 0||l.add(this.$)},unmounted:function(){var l;(l=this.$rows)===null||l===void 0||l.delete(this.$)},render:function(){return null}};const ms={class:"flex flex-col items-start px-8 pb-4 gap-4"},fs={class:"flex items-center justify-between gap-2 w-full"},vs={class:"flex flex-col gap-2"},hs={class:"text-3xl"},gs={class:"text-2xl"},ys={class:"text-sm"},_s={class:"flex items-center self-end"},bs={class:"text-xl"},$s={class:"text-gray-500"},ws={class:"flex items-center"},Cs={class:"flex-grow flex gap-2 items-center"},xs={class:"flex gap-2 items-center justify-between w-full"},Ss={class:"flex-grow"},ks={class:"w-full text-center"},Ts={class:"w-full text-center"},Is=["onClick"],Ns={class:"flex flex-col"},Vs={key:0,class:"pi pi-check",style:{"font-size":"10px"}},Fs={key:1,class:"pi pi-ellipsis-h",style:{"font-size":"10px"}},Ds={class:"text-right"},js={class:"flex justify-center text-[124px]"},Rs={class:"flex justify-between items-center mb-8"},Ls={class:"flex justify-end gap-2"},it=Ge({__name:"ClassPage",setup(k){const l=Ue(),Y=Ae(),$=Ye(),ae=Ke(),{t:d}=Ee(),be=m(),L=m();(()=>{L.value={global:{value:null,matchMode:Je.CONTAINS}}})();const $e=()=>{var u,j,O;const e=[d("pages.teacher.name"),d("pages.teacher.xp"),...F.value.map(_=>`${_.lessonName} (${_.lessonId})`)],s=(u=X.value)==null?void 0:u.map(_=>{const N=[];N.push(`"${_.name.length>0?_.name:_.email}"`);const ee=re(_.id);N.push(`"${ee}/${ne.value}"`);for(const se of F.value){const R=D(_.id,se.lessonId);N.push(`${R}%`)}return N.join(",")}).join(`
`),p=(((j=w.value)==null?void 0:j.schoolName)??"")+`
`+(((O=w.value)==null?void 0:O.name)??"")+`
`+e.join(",")+`
`+s,y=new Blob([p],{type:"text/csv;charset=utf-8;"}),U=URL.createObjectURL(y),I=document.createElement("a");I.setAttribute("href",U),I.setAttribute("download",`class_progress_${new Date().toISOString()}.csv`),document.body.appendChild(I),I.click(),document.body.removeChild(I)},we=Me(),{userInfo:T}=Oe(we),K=m(!1),w=m(null),P=m([]),h=m([]),g=m(["learn","practice"]),z=A(()=>{if(h.value.length==0||g.value.length==0)return[];const e=new Set(h.value),s=h.value.length>0,a=new Set(g.value),p=g.value.length>0&&g.value.length<ye.length;return P.value.filter(y=>!s||e.has(y.id)).map(y=>({...y,lessons:y.lessons.filter(U=>!p||a.has(U.lessonType))}))}),oe=A(()=>{const e={};for(const s of z.value)e[s.id]=s.lessons.length;return e}),le=A(()=>{const e={};for(const s of z.value){e[s.id]={};for(const a of s.levels)e[s.id][a.id]=0;for(const a of s.lessons)a.stage=="published"&&(e[s.id][a.levelId]=(e[s.id][a.levelId]??0)+1)}return e}),F=A(()=>{const e=[];for(const s of z.value)for(const a of s.levels)for(const p of s.lessons.filter(y=>y.levelId===a.id))p.stage=="published"&&e.push({routeId:s.id,levelId:a.id,lessonId:p.id,lessonType:p.lessonType,lessonName:p.name});return e}),ne=A(()=>F.value.length);function re(e){let s=0;for(const a of F.value)D(e,a.lessonId)>=100&&(s+=1);return s}function J(e){return e==="learn"?"bg-primary400":e==="practice"?"bg-purple400":e==="module"?"bg-warning400":"bg-blue400"}async function Q(){var e;try{const{data:s}=await V.getClass(Number($.params.id));w.value=ns(s),((e=T.value)==null?void 0:e.user_type)=="school_manager"&&(await je(),G.value=Z.value.find(a=>{var p;return a.teacher_id==((p=w.value)==null?void 0:p.creator)})??null)}catch(s){console.log(s)}}async function Ce(){try{const{data:e}=await os.getRoutes();P.value=(e==null?void 0:e.map(ls))??[]}catch(e){console.log(e)}}async function xe(){try{const{data:e}=await V.getClassStudentsProgress(Number($.params.id),h.value,g.value),s={};for(const a of e.progress_data??[])s[a.student_id]||(s[a.student_id]={}),s[a.student_id][a.lesson_id]=a.completed?100:a.student_progress;ie.value=s}catch(e){console.log(e)}}const ie=m({});function D(e,s){var a;return((a=ie.value[e])==null?void 0:a[s])??0}function Se(e){return e>=100?"bg-primary400":e>0?"bg-warning400":"bg-neutral100"}const W=m(!1),X=m();async function ue(e){try{W.value=!0;const{data:s}=await V.getClassStudents(e);X.value=(s==null?void 0:s.map(rs))??[]}catch(s){l.add({severity:"error",summary:s.response.data.error,life:2e3})}finally{W.value=!1}}qe(async()=>{await Q(),await Ce(),await ue(Number($.params.id)),P.value.length>0&&(h.value=[P.value[0].id])}),He([h,g],async()=>{h.value.length==0||g.value.length==0||await xe()});function ke(){Y.require({message:d("pages.teacher.areYouSureDeleteClass"),header:d("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:d("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:d("pages.teacher.delete"),severity:"danger"},accept:()=>{Te(Number($.params.id))}})}async function Te(e){try{const{data:s}=await V.deleteClass(e);ae.go(-1),l.add({severity:"success",summary:s.message,life:2e3})}catch(s){l.add({severity:"error",summary:s.response.data.error,detail:s,life:2e3})}}function Ie(e){Y.require({message:d("pages.teacher.areYouSureExpelStudent"),header:d("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:d("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:d("pages.teacher.expel"),severity:"danger"},accept:()=>{Ne(e)}})}async function Ne(e){try{const{data:s}=await V.expelStudentFromClass(Number($.params.id),e);await ue(Number($.params.id)),l.add({severity:"success",summary:s.message,life:2e3})}catch(s){l.add({severity:"error",summary:s.response.data.error,detail:s,life:2e3})}}const M=m(!1),B=m(!1),G=m(null);async function Ve(){if(G.value){M.value=!0;try{await V.assignTeacherToClass(Number($.params.id),G.value.teacher_id),await Q()}catch(e){console.log(e)}finally{M.value=!1,B.value=!1}}}function Fe(){Y.require({message:d("pages.school.confirmDeleteTeacher"),header:d("pages.school.confirmHeader"),icon:"pi pi-exclamation-triangle",rejectProps:{label:d("pages.school.confirmCancel"),severity:"secondary",outlined:!0},acceptProps:{label:d("pages.school.confirmDeleteBtn"),severity:"danger"},accept:()=>{De()}})}async function De(){try{const{data:e}=await V.assignTeacherToClass(Number($.params.id));await Q(),l.add({severity:"success",summary:e.message,life:2e3})}catch(e){l.add({severity:"error",summary:e.response.data.error,detail:e,life:2e3})}}const Z=m([]);async function je(){const{data:e}=await is.getTeachers();Z.value=e??[]}return(e,s)=>{const a=Qe,p=as,y=es,U=ts,I=ss,u=Xe,j=ps,O=ds,_=Ze,N=We,ee=ze,se=Pe,R=Le;return n(),b(se,{class:"flex-grow flex flex-col gap-2"},{default:i(()=>{var ce,de,pe,me,fe,ve,he,ge;return[r("div",ms,[r("div",fs,[r("div",vs,[r("div",hs,f((ce=w.value)==null?void 0:ce.schoolName),1),r("div",gs,f((de=w.value)==null?void 0:de.name),1),r("div",ys,f(e.$t("pages.teacher.since"))+" "+f((pe=w.value)==null?void 0:pe.createdTime),1)]),["teacher","school_manager"].includes(((me=C(T))==null?void 0:me.user_type)??"")?(n(),b(a,{key:0,icon:"pi pi-hashtag",label:e.$t("pages.teacher.classCode"),severity:"info",onClick:s[0]||(s[0]=t=>K.value=!0)},null,8,["label"])):x("",!0)]),r("div",_s,[r("div",bs,[r("span",$s,f(e.$t("pages.teacher.teacher")),1),te(" "+f((fe=w.value)==null?void 0:fe.creatorName),1)]),((ve=C(T))==null?void 0:ve.user_type)=="school_manager"?(n(),b(a,{key:0,icon:"pi pi-pencil",severity:"info",variant:"text",rounded:"",onClick:s[1]||(s[1]=t=>B.value=!0)})):x("",!0),((he=C(T))==null?void 0:he.user_type)=="school_manager"?(n(),b(a,{key:1,icon:"pi pi-trash",severity:"danger",variant:"text",rounded:"",onClick:Fe})):x("",!0)]),o(_,{ref_key:"dt",ref:be,filters:L.value,"onUpdate:filters":s[5]||(s[5]=t=>L.value=t),value:X.value,dataKey:"id",loading:W.value,scrollable:"",globalFilterFields:["name","email"],class:"overflow-hidden w-full",paginator:"",rows:25,rowsPerPageOptions:[5,10,25],groupHeader:!0,showGridlines:""},{header:i(()=>[r("div",ws,[r("div",Cs,[o(p,{class:"min-w-[220px]",options:P.value.map(t=>({label:t.name,value:t.id})),optionLabel:"label",invalid:h.value.length===0,optionValue:"value",display:"chip",modelValue:h.value,"onUpdate:modelValue":s[2]||(s[2]=t=>h.value=t),placeholder:e.$t("courses")},null,8,["options","invalid","modelValue","placeholder"]),o(p,{class:"min-w-[220px]",options:C(ye),optionLabel:t=>t,optionValue:t=>t,display:"chip",modelValue:g.value,"onUpdate:modelValue":s[3]||(s[3]=t=>g.value=t),placeholder:e.$t("lessonType"),invalid:g.value.length===0},{option:i(({option:t})=>[r("div",xs,[r("div",Ss,f(t.charAt(0).toUpperCase()+t.slice(1)),1),r("div",{class:q(["w-3 h-3 rounded-full mx-auto",J(t)])},null,2)])]),_:1},8,["options","optionLabel","optionValue","modelValue","placeholder","invalid"])]),o(a,{label:e.$t("export"),icon:"pi pi-upload",severity:"info",variant:"outlined",class:"mr-2",onClick:$e},null,8,["label"]),o(I,null,{default:i(()=>[o(y,null,{default:i(()=>s[10]||(s[10]=[r("i",{class:"pi pi-search"},null,-1)])),_:1}),o(U,{modelValue:L.value.global.value,"onUpdate:modelValue":s[4]||(s[4]=t=>L.value.global.value=t),placeholder:e.$t("pages.teacher.search")},null,8,["modelValue","placeholder"])]),_:1})])]),empty:i(()=>[te(f(e.$t("pages.teacher.noStudentsFound")),1)]),loading:i(()=>[te(f(e.$t("pages.teacher.loadingStudents")),1)]),default:i(()=>[o(O,{type:"header"},{default:i(()=>[o(j,null,{default:i(()=>[o(u,{header:e.$t("lessons"),rowspan:2,colspan:1,frozen:!0,alignFrozen:"left"},null,8,["header"]),(n(!0),v(S,null,E(z.value,t=>(n(),v(S,{key:t.id},[oe.value[t.id]>0?(n(),b(u,{key:0,colspan:oe.value[t.id]},{header:i(()=>[r("div",ks,f(t.name),1)]),_:2},1032,["colspan"])):x("",!0)],64))),128)),o(u,{header:"",rowspan:2,colspan:2})]),_:1}),o(j,null,{default:i(()=>[(n(!0),v(S,null,E(z.value,t=>(n(),v(S,{key:t.id},[(n(!0),v(S,null,E(t.levels,c=>(n(),v(S,{key:c.id},[le.value[t.id][c.id]>0?(n(),b(u,{key:0,colspan:le.value[t.id][c.id]},{header:i(()=>[r("div",Ts,f(c.name),1)]),_:2},1032,["colspan"])):x("",!0)],64))),128))],64))),128))]),_:1}),o(j,null,{default:i(()=>[o(u,{header:e.$t("pages.teacher.name"),frozen:!0,alignFrozen:"left",sortable:"",field:"name"},null,8,["header"]),(n(!0),v(S,null,E(F.value,t=>(n(),b(u,{key:t.lessonId,field:t.lessonId.toString()},{header:i(()=>{var c;return[["super_admin","admin-viewer","school_manager","teacher"].includes(((c=C(T))==null?void 0:c.user_type)??"")?H((n(),v("i",{key:0,class:q(["pi pi-external-link mx-auto cursor-pointer hover:opacity-80 transition-opacity text-sm",J(t.lessonType)]),onClick:Re=>C(ae).push(`/teacher/class/${C($).params.id}/lesson/${t.lessonId}`)},null,10,Is)),[[R,{value:t.lessonName.toString()},void 0,{top:!0}]]):H((n(),v("div",{key:1,class:q(["w-3 h-3 rounded-full mx-auto",J(t.lessonType)])},null,2)),[[R,{value:t.lessonName.toString()},void 0,{top:!0}]])]}),_:2},1032,["field"]))),128)),o(u,{header:e.$t("pages.teacher.xp"),field:"xp",frozen:!0,alignFrozen:"right"},null,8,["header"]),o(u,{header:""})]),_:1})]),_:1}),o(u,{field:"name",sortable:"",frozen:!0,alignFrozen:"left"},{body:i(({data:t})=>[r("div",Ns,[r("div",null,f(`${t.name.length>0?t.name:t.email}`),1)])]),_:1}),(n(!0),v(S,null,E(F.value,t=>(n(),b(u,{key:t.lessonId,field:t.lessonId.toString()},{body:i(({data:c})=>[H((n(),v("div",{class:q(["w-4 h-4 p-1 rounded-full mx-auto flex items-center justify-center text-white",Se(D(c.id,t.lessonId))])},[D(c.id,t.lessonId)>=100?(n(),v("i",Vs)):D(c.id,t.lessonId)>0?(n(),v("i",Fs)):x("",!0)],2)),[[R,{value:D(c.id,t.lessonId).toString()+"%"},void 0,{top:!0}]])]),_:2},1032,["field"]))),128)),o(u,{field:"xp",frozen:!0,alignFrozen:"right"},{body:i(({data:t})=>[r("div",Ds,f(`${re(t.id)}/${ne.value}`),1)]),_:1}),o(u,{exportable:!1},{body:i(({data:t})=>{var c;return[["teacher","school_manager"].includes(((c=C(T))==null?void 0:c.user_type)??"")?H((n(),b(a,{key:0,icon:"pi pi-user-minus",rounded:"",variant:"text",severity:"danger",onClick:Re=>Ie(t.id)},null,8,["onClick"])),[[R,e.$t("pages.teacher.expelFromClass")]]):x("",!0)]}),_:1})]),_:1},8,["filters","value","loading"]),["teacher","school_manager"].includes(((ge=C(T))==null?void 0:ge.user_type)??"")?(n(),b(a,{key:0,icon:"pi pi-trash",label:e.$t("pages.teacher.removeClass"),severity:"danger",onClick:ke,class:"self-end"},null,8,["label"])):x("",!0)]),o(N,{visible:K.value,"onUpdate:visible":s[6]||(s[6]=t=>K.value=t),modal:"",header:e.$t("pages.teacher.classCode")},{default:i(()=>{var t;return[r("div",js,f((t=w.value)==null?void 0:t.code),1)]}),_:1},8,["visible","header"]),o(N,{visible:B.value,"onUpdate:visible":s[9]||(s[9]=t=>B.value=t),modal:"",header:e.$t("pages.school.assignTeacher"),closable:!1},{default:i(()=>[r("div",Rs,[o(ee,{modelValue:G.value,"onUpdate:modelValue":s[7]||(s[7]=t=>G.value=t),options:Z.value,"option-label":"email",placeholder:e.$t("pages.school.selectTeacher")},null,8,["modelValue","options","placeholder"])]),r("div",Ls,[o(a,{type:"button",label:e.$t("pages.school.cancel"),severity:"secondary",onClick:s[8]||(s[8]=t=>B.value=!1)},null,8,["label"]),o(a,{type:"button",label:e.$t("pages.school.assign"),onClick:Ve,loading:M.value,disabled:M.value},null,8,["label","loading","disabled"])])]),_:1},8,["visible","header"])]}),_:1})}}});export{it as default};
