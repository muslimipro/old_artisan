import{T as Ne}from"./index-Br5iJuVg.js";import{s as De}from"./index-CtaZDtwr.js";import{s as Le}from"./index-OdaeILGb.js";import{B as Pe,s as ce,b as ze,u as Re,a1 as je,a as Be,r as u,f as Ge,e as Ae,x as D,g as Ue,E as Me,o as i,p as x,D as r,j as n,t as c,h as o,k as J,i as S,q as L,n as G,c as p,l as P,F as b,y as A,C as Ee,v as qe,aH as He,w as Oe,L as Ye}from"./index-DKpYZndv.js";import{s as Ke,a as Je}from"./index-CuTemcOB.js";import{a as Qe,b as We}from"./index-Dc-zD-v2.js";import{s as Xe}from"./index-C_i3kvzb.js";import{s as Ze}from"./index-BbRcFv5x.js";import{R as et,m as tt}from"./mapRouteFromDto-CoNpX0pF.js";import{A as ue}from"./lessonType-v5Tmr0TL.js";import{C as w}from"./classApi-0pJ-kt-z.js";import{m as st}from"./mapStudentFromDto-D4MSietx.js";import{m as at}from"./mapClassFromDto-DgC5mjEL.js";import{S as ot}from"./schoolApi-ly85vefR.js";import"./index-CRjM1jwi.js";import"./index-C0_NxIx7.js";import"./index-CdXgfwks.js";import"./index-CQW4Wi6y.js";import"./index-BPXX-HAT.js";import"./index-BHdrZhke.js";import"./index-DG5KcTt3.js";import"./index-D9s7_hLW.js";import"./index-Bx1U5VWS.js";import"./mapLessonFromDto-D3cEBYeg.js";import"./mapUnitFromDto-DVWJHO4f.js";import"./transformUnitDtosToPages-hsgZNhAG.js";var lt=Pe.extend({name:"columngroup"}),nt={name:"BaseColumnGroup",extends:ce,props:{type:{type:String,default:null}},style:lt,provide:function(){return{$pcColumnGroup:this,$parentInstance:this}}},rt={name:"ColumnGroup",extends:nt,inheritAttrs:!1,inject:["$columnGroups"],mounted:function(){var l;(l=this.$columnGroups)===null||l===void 0||l.add(this.$)},unmounted:function(){var l;(l=this.$columnGroups)===null||l===void 0||l.delete(this.$)},render:function(){return null}},it={name:"Row",extends:ce,inject:["$rows"],mounted:function(){var l;(l=this.$rows)===null||l===void 0||l.add(this.$)},unmounted:function(){var l;(l=this.$rows)===null||l===void 0||l.delete(this.$)},render:function(){return null}};const ut={class:"flex flex-col items-start px-8 pb-4 gap-4"},ct={class:"flex items-center justify-between gap-2 w-full"},dt={class:"flex flex-col gap-2"},pt={class:"text-3xl"},mt={class:"text-sm"},ft={class:"flex items-center self-end"},vt={class:"text-xl"},ht={class:"text-gray-500"},gt={class:"flex items-center"},yt={class:"flex-grow flex gap-2 items-center"},_t={class:"flex gap-2 items-center justify-between w-full"},bt={class:"flex-grow"},$t={class:"w-full text-center"},xt={class:"w-full text-center"},wt=["onClick"],Ct={class:"flex flex-col"},St={class:"text-[10px] text-gray-500"},Tt={key:0,class:"pi pi-check",style:{"font-size":"10px"}},kt={key:1,class:"pi pi-ellipsis-h",style:{"font-size":"10px"}},It={class:"text-right"},Vt={class:"flex justify-center text-[124px]"},Ft={class:"flex justify-between items-center mb-8"},Nt={class:"flex justify-end gap-2"},ns=ze({__name:"ClassPage",setup($){const l=Re(),U=je(),y=Ee(),Q=qe(),{t:m}=Be(),W=u(),T=u();(()=>{T.value={global:{value:null,matchMode:He.CONTAINS}}})();const de=()=>{W.value.exportCSV()},pe=Ge(),{userInfo:z}=Ae(pe),M=u(!1),C=u(null),k=u([]),h=u([]),g=u(["learn","practice"]),I=D(()=>{if(h.value.length==0||g.value.length==0)return[];const e=new Set(h.value),t=h.value.length>0,a=new Set(g.value),v=g.value.length>0&&g.value.length<ue.length;return k.value.filter(_=>!t||e.has(_.id)).map(_=>({..._,lessons:_.lessons.filter(Y=>!v||a.has(Y.lessonType))}))}),X=D(()=>{const e={};for(const t of I.value)e[t.id]=t.lessons.length;return e}),Z=D(()=>{const e={};for(const t of I.value){e[t.id]={};for(const a of t.levels)e[t.id][a.id]=0;for(const a of t.lessons)e[t.id][a.levelId]=(e[t.id][a.levelId]??0)+1}return e}),R=D(()=>{const e=[];for(const t of I.value)for(const a of t.levels)for(const v of t.lessons.filter(_=>_.levelId===a.id))e.push({routeId:t.id,levelId:a.id,lessonId:v.id,lessonType:v.lessonType,lessonName:v.name});return e}),me=D(()=>R.value.length);function fe(e){let t=0;for(const a of R.value)V(e,a.lessonId)>=100&&(t+=1);return t}function E(e){return e==="learn"?"bg-primary400":e==="practice"?"bg-purple400":e==="module"?"bg-warning400":"bg-blue400"}async function q(){var e;try{const{data:t}=await w.getClass(Number(y.params.id));C.value=at(t),((e=z.value)==null?void 0:e.user_type)=="school_manager"&&(await Se(),N.value=O.value.find(a=>{var v;return a.teacher_id==((v=C.value)==null?void 0:v.creator)})??null)}catch(t){console.log(t)}}async function ve(){try{const{data:e}=await et.getRoutes();k.value=(e==null?void 0:e.map(tt))??[]}catch(e){console.log(e)}}async function he(){try{const{data:e}=await w.getClassStudentsProgress(Number(y.params.id),h.value,g.value),t={};for(const a of e.progress_data??[])t[a.student_id]||(t[a.student_id]={}),t[a.student_id][a.lesson_id]=a.student_progress;ee.value=t}catch(e){console.log(e)}}const ee=u({});function V(e,t){var a;return((a=ee.value[e])==null?void 0:a[t])??0}function ge(e){return e>=100?"bg-primary400":e>0?"bg-warning400":"bg-neutral100"}const H=u(!1),te=u();async function se(e){try{H.value=!0;const{data:t}=await w.getClassStudents(e);te.value=(t==null?void 0:t.map(st))??[]}catch(t){l.add({severity:"error",summary:t.response.data.error,life:2e3})}finally{H.value=!1}}Ue(async()=>{await q(),await ve(),await se(Number(y.params.id)),k.value.length>0&&(h.value=[k.value[0].id])}),Me([h,g],async()=>{h.value.length==0||g.value.length==0||await he()});function ye(){U.require({message:m("pages.teacher.areYouSureDeleteClass"),header:m("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:m("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:m("pages.teacher.delete"),severity:"danger"},accept:()=>{_e(Number(y.params.id))}})}async function _e(e){try{const{data:t}=await w.deleteClass(e);Q.go(-1),l.add({severity:"success",summary:t.message,life:2e3})}catch(t){l.add({severity:"error",summary:t.response.data.error,detail:t,life:2e3})}}function be(e){U.require({message:m("pages.teacher.areYouSureExpelStudent"),header:m("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:m("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:m("pages.teacher.expel"),severity:"danger"},accept:()=>{$e(e)}})}async function $e(e){try{const{data:t}=await w.expelStudentFromClass(Number(y.params.id),e);await se(Number(y.params.id)),l.add({severity:"success",summary:t.message,life:2e3})}catch(t){l.add({severity:"error",summary:t.response.data.error,detail:t,life:2e3})}}const j=u(!1),F=u(!1),N=u(null);async function xe(){if(N.value){j.value=!0;try{await w.assignTeacherToClass(Number(y.params.id),N.value.teacher_id),await q()}catch(e){console.log(e)}finally{j.value=!1,F.value=!1}}}function we(){U.require({message:m("pages.school.confirmDeleteTeacher"),header:m("pages.school.confirmHeader"),icon:"pi pi-exclamation-triangle",rejectProps:{label:m("pages.school.confirmCancel"),severity:"secondary",outlined:!0},acceptProps:{label:m("pages.school.confirmDeleteBtn"),severity:"danger"},accept:()=>{Ce()}})}async function Ce(){try{const{data:e}=await w.assignTeacherToClass(Number(y.params.id));await q(),l.add({severity:"success",summary:e.message,life:2e3})}catch(e){l.add({severity:"error",summary:e.response.data.error,detail:e,life:2e3})}}const O=u([]);async function Se(){const{data:e}=await ot.getTeachers();O.value=e??[]}return(e,t)=>{const a=Oe,v=Ze,_=Qe,Y=Xe,Te=We,f=Ke,K=it,ke=rt,Ie=Je,ae=Ye,Ve=Le,Fe=De,B=Ne;return i(),x(Fe,{class:"flex-grow flex flex-col gap-2"},{default:r(()=>{var oe,le,ne,re,ie;return[n("div",ut,[n("div",ct,[n("div",dt,[n("div",pt,c((oe=C.value)==null?void 0:oe.name),1),n("div",mt,c(e.$t("pages.teacher.since"))+" "+c((le=C.value)==null?void 0:le.createdTime),1)]),o(a,{icon:"pi pi-hashtag",label:e.$t("pages.teacher.classCode"),severity:"info",onClick:t[0]||(t[0]=s=>M.value=!0)},null,8,["label"])]),n("div",ft,[n("div",vt,[n("span",ht,c(e.$t("pages.teacher.teacher")),1),J(" "+c((ne=C.value)==null?void 0:ne.creatorName),1)]),((re=S(z))==null?void 0:re.user_type)=="school_manager"?(i(),x(a,{key:0,icon:"pi pi-pencil",severity:"info",variant:"text",rounded:"",onClick:t[1]||(t[1]=s=>F.value=!0)})):L("",!0),((ie=S(z))==null?void 0:ie.user_type)=="school_manager"?(i(),x(a,{key:1,icon:"pi pi-trash",severity:"danger",variant:"text",rounded:"",onClick:we})):L("",!0)]),o(Ie,{ref_key:"dt",ref:W,filters:T.value,"onUpdate:filters":t[5]||(t[5]=s=>T.value=s),value:te.value,dataKey:"id",loading:H.value,scrollable:"",globalFilterFields:["name","email"],class:"overflow-hidden w-full",paginator:"",rows:25,rowsPerPageOptions:[5,10,25],groupHeader:!0,showGridlines:""},{header:r(()=>[n("div",gt,[n("div",yt,[o(v,{class:"min-w-[220px]",options:k.value.map(s=>({label:s.name,value:s.id})),optionLabel:"label",invalid:h.value.length===0,optionValue:"value",display:"chip",modelValue:h.value,"onUpdate:modelValue":t[2]||(t[2]=s=>h.value=s),placeholder:e.$t("courses")},null,8,["options","invalid","modelValue","placeholder"]),o(v,{class:"min-w-[220px]",options:S(ue),optionLabel:s=>s,optionValue:s=>s,display:"chip",modelValue:g.value,"onUpdate:modelValue":t[3]||(t[3]=s=>g.value=s),placeholder:e.$t("lessonType"),invalid:g.value.length===0},{option:r(({option:s})=>[n("div",_t,[n("div",bt,c(s.charAt(0).toUpperCase()+s.slice(1)),1),n("div",{class:G(["w-3 h-3 rounded-full mx-auto",E(s)])},null,2)])]),_:1},8,["options","optionLabel","optionValue","modelValue","placeholder","invalid"])]),o(a,{label:e.$t("export"),icon:"pi pi-upload",severity:"info",variant:"outlined",class:"mr-2",onClick:de},null,8,["label"]),o(Te,null,{default:r(()=>[o(_,null,{default:r(()=>t[10]||(t[10]=[n("i",{class:"pi pi-search"},null,-1)])),_:1}),o(Y,{modelValue:T.value.global.value,"onUpdate:modelValue":t[4]||(t[4]=s=>T.value.global.value=s),placeholder:e.$t("pages.teacher.search")},null,8,["modelValue","placeholder"])]),_:1})])]),empty:r(()=>[J(c(e.$t("pages.teacher.noStudentsFound")),1)]),loading:r(()=>[J(c(e.$t("pages.teacher.loadingStudents")),1)]),default:r(()=>[o(ke,{type:"header"},{default:r(()=>[o(K,null,{default:r(()=>[o(f,{header:e.$t("lessons"),rowspan:2,colspan:1,frozen:!0,alignFrozen:"left"},null,8,["header"]),(i(!0),p(b,null,P(I.value,s=>(i(),p(b,{key:s.id},[X.value[s.id]>0?(i(),x(f,{key:0,colspan:X.value[s.id]},{header:r(()=>[n("div",$t,c(s.name),1)]),_:2},1032,["colspan"])):L("",!0)],64))),128)),o(f,{header:"",rowspan:2,colspan:2})]),_:1}),o(K,null,{default:r(()=>[(i(!0),p(b,null,P(I.value,s=>(i(),p(b,{key:s.id},[(i(!0),p(b,null,P(s.levels,d=>(i(),p(b,{key:d.id},[Z.value[s.id][d.id]>0?(i(),x(f,{key:0,colspan:Z.value[s.id][d.id]},{header:r(()=>[n("div",xt,c(d.name),1)]),_:2},1032,["colspan"])):L("",!0)],64))),128))],64))),128))]),_:1}),o(K,null,{default:r(()=>[o(f,{header:e.$t("pages.teacher.name"),frozen:!0,alignFrozen:"left",sortable:"",field:"name"},null,8,["header"]),(i(!0),p(b,null,P(R.value,s=>(i(),x(f,{key:s.lessonId,field:s.lessonId.toString()},{header:r(()=>{var d;return[["super_admin","teacher"].includes(((d=S(z))==null?void 0:d.user_type)??"")?A((i(),p("i",{key:0,class:G(["pi pi-external-link mx-auto cursor-pointer hover:opacity-80 transition-opacity text-sm",E(s.lessonType)]),onClick:Lt=>S(Q).push(`/teacher/class/${S(y).params.id}/lesson/${s.lessonId}`)},null,10,wt)),[[B,{value:s.lessonName.toString()},void 0,{top:!0}]]):A((i(),p("div",{key:1,class:G(["w-3 h-3 rounded-full mx-auto",E(s.lessonType)])},null,2)),[[B,{value:s.lessonName.toString()},void 0,{top:!0}]])]}),_:2},1032,["field"]))),128)),o(f,{header:e.$t("pages.teacher.xp"),field:"xp",frozen:!0,alignFrozen:"right"},null,8,["header"]),o(f,{header:""})]),_:1})]),_:1}),o(f,{field:"name",sortable:"",frozen:!0,alignFrozen:"left"},{body:r(({data:s})=>[n("div",Ct,[n("div",null,c(`${s.name.length>0?s.name:s.email}`),1),n("div",St,c(`Last visited: ${s.lastActivityTime.toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}`),1)])]),_:1}),(i(!0),p(b,null,P(R.value,s=>(i(),x(f,{key:s.lessonId,field:s.lessonId.toString()},{body:r(({data:d})=>[A((i(),p("div",{class:G(["w-4 h-4 p-1 rounded-full mx-auto flex items-center justify-center text-white",ge(V(d.id,s.lessonId))])},[V(d.id,s.lessonId)>=100?(i(),p("i",Tt)):V(d.id,s.lessonId)>0?(i(),p("i",kt)):L("",!0)],2)),[[B,{value:V(d.id,s.lessonId).toString()+"%"},void 0,{top:!0}]])]),_:2},1032,["field"]))),128)),o(f,{field:"xp",frozen:!0,alignFrozen:"right"},{body:r(({data:s})=>[n("div",It,c(`${fe(s.id)}/${me.value}`),1)]),_:1}),o(f,{exportable:!1},{body:r(({data:s})=>[A(o(a,{icon:"pi pi-user-minus",rounded:"",variant:"text",severity:"danger",onClick:d=>be(s.id)},null,8,["onClick"]),[[B,e.$t("pages.teacher.expelFromClass")]])]),_:1})]),_:1},8,["filters","value","loading"]),o(a,{icon:"pi pi-trash",label:e.$t("pages.teacher.removeClass"),severity:"danger",onClick:ye,class:"self-end"},null,8,["label"])]),o(ae,{visible:M.value,"onUpdate:visible":t[6]||(t[6]=s=>M.value=s),modal:"",header:e.$t("pages.teacher.classCode")},{default:r(()=>{var s;return[n("div",Vt,c((s=C.value)==null?void 0:s.code),1)]}),_:1},8,["visible","header"]),o(ae,{visible:F.value,"onUpdate:visible":t[9]||(t[9]=s=>F.value=s),modal:"",header:e.$t("pages.school.assignTeacher"),closable:!1},{default:r(()=>[n("div",Ft,[o(Ve,{modelValue:N.value,"onUpdate:modelValue":t[7]||(t[7]=s=>N.value=s),options:O.value,"option-label":"email",placeholder:e.$t("pages.school.selectTeacher")},null,8,["modelValue","options","placeholder"])]),n("div",Nt,[o(a,{type:"button",label:e.$t("pages.school.cancel"),severity:"secondary",onClick:t[8]||(t[8]=s=>F.value=!1)},null,8,["label"]),o(a,{type:"button",label:e.$t("pages.school.assign"),onClick:xe,loading:j.value,disabled:j.value},null,8,["label","loading","disabled"])])]),_:1},8,["visible","header"])]}),_:1})}}});export{ns as default};
