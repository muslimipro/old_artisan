import{T as Fe}from"./index-lKeh-AGk.js";import{s as Ne}from"./index-CC4qZ86A.js";import{s as De}from"./index-CnKqUMsb.js";import{B as Le,s as ue,b as Pe,u as ze,a0 as Re,a as je,r as u,f as Be,e as Ge,x as N,g as Ae,D as Ue,o as i,p as w,y as r,j as l,t as c,h as o,k as O,i as D,q as L,n as Y,c as v,l as P,F as b,a3 as J,C as Me,v as Ee,aH as qe,w as He,J as Oe}from"./index-CnKe9SRm.js";import{s as Ye,a as Je}from"./index-BzcUM8zt.js";import{a as Ke,b as Qe}from"./index-DKJZLhcG.js";import{s as We}from"./index-DmQw6gan.js";import{s as Xe}from"./index-C_SHD9V_.js";import{R as Ze,m as et}from"./mapRouteFromDto-PSN50FDR.js";import{A as ie}from"./lessonType-v5Tmr0TL.js";import{C as x,m as tt}from"./mapClassFromDto-DdHQS3uK.js";import{m as st}from"./mapStudentFromDto-D4MSietx.js";import{S as at}from"./schoolApi-DN4X6o-z.js";import"./index-Bzs2LotI.js";import"./index-D_SA3pqJ.js";import"./index-D6P5SBNN.js";import"./index-D8XcetXe.js";import"./index-DDLJupJ2.js";import"./index-CDFkGpQT.js";import"./index-DyVOO59P.js";import"./index-BrO1a620.js";import"./index-Ot9NVZDH.js";import"./mapLessonFromDto-De7FAIVI.js";import"./mapUnitFromDto-DVWJHO4f.js";import"./transformUnitDtosToPages-hsgZNhAG.js";var ot=Le.extend({name:"columngroup"}),lt={name:"BaseColumnGroup",extends:ue,props:{type:{type:String,default:null}},style:ot,provide:function(){return{$pcColumnGroup:this,$parentInstance:this}}},nt={name:"ColumnGroup",extends:lt,inheritAttrs:!1,inject:["$columnGroups"],mounted:function(){var n;(n=this.$columnGroups)===null||n===void 0||n.add(this.$)},unmounted:function(){var n;(n=this.$columnGroups)===null||n===void 0||n.delete(this.$)},render:function(){return null}},rt={name:"Row",extends:ue,inject:["$rows"],mounted:function(){var n;(n=this.$rows)===null||n===void 0||n.add(this.$)},unmounted:function(){var n;(n=this.$rows)===null||n===void 0||n.delete(this.$)},render:function(){return null}};const it={class:"flex flex-col items-start px-8 pb-4 gap-4"},ut={class:"flex items-center justify-between gap-2 w-full"},ct={class:"flex flex-col gap-2"},dt={class:"text-3xl"},pt={class:"text-sm"},mt={class:"flex items-center self-end"},ft={class:"text-xl"},vt={class:"text-gray-500"},gt={class:"flex items-center"},ht={class:"flex-grow flex gap-2 items-center"},yt={class:"flex gap-2 items-center justify-between w-full"},_t={class:"flex-grow"},bt={class:"w-full text-center"},$t={class:"w-full text-center"},wt=["onClick"],xt={class:"flex flex-col"},Ct={class:"text-[10px] text-gray-500"},St={key:0,class:"pi pi-check",style:{"font-size":"10px"}},Tt={key:1,class:"pi pi-ellipsis-h",style:{"font-size":"10px"}},kt={class:"text-right"},It={class:"flex justify-center text-[124px]"},Vt={class:"flex justify-between items-center mb-8"},Ft={class:"flex justify-end gap-2"},as=Pe({__name:"ClassPage",setup($){const n=ze(),j=Re(),y=Me(),K=Ee(),{t:d}=je(),ce=u(),S=u();(()=>{S.value={global:{value:null,matchMode:qe.CONTAINS}}})();const de=Be(),{userInfo:B}=Ge(de),G=u(!1),C=u(null),T=u([]),g=u([]),h=u(["learn","practice"]),k=N(()=>{if(g.value.length==0||h.value.length==0)return[];const e=new Set(g.value),t=g.value.length>0,a=new Set(h.value),m=h.value.length>0&&h.value.length<ie.length;return T.value.filter(_=>!t||e.has(_.id)).map(_=>({..._,lessons:_.lessons.filter(E=>!m||a.has(E.lessonType))}))}),Q=N(()=>{const e={};for(const t of k.value)e[t.id]=t.lessons.length;return e}),W=N(()=>{const e={};for(const t of k.value){e[t.id]={};for(const a of t.levels)e[t.id][a.id]=0;for(const a of t.lessons)e[t.id][a.levelId]=(e[t.id][a.levelId]??0)+1}return e}),z=N(()=>{const e=[];for(const t of k.value)for(const a of t.levels)for(const m of t.lessons.filter(_=>_.levelId===a.id))e.push({routeId:t.id,levelId:a.id,lessonId:m.id,lessonType:m.lessonType,lessonName:m.name});return e}),pe=N(()=>z.value.length);function me(e){let t=0;for(const a of z.value)I(e,a.lessonId)>=100&&(t+=1);return t}function X(e){return e==="learn"?"bg-primary400":e==="practice"?"bg-purple400":e==="module"?"bg-warning400":"bg-blue400"}async function A(){var e;try{const{data:t}=await x.getClass(Number(y.params.id));C.value=tt(t),((e=B.value)==null?void 0:e.user_type)=="school_manager"&&(await Ce(),F.value=M.value.find(a=>{var m;return a.teacher_id==((m=C.value)==null?void 0:m.creator)})??null)}catch(t){console.log(t)}}async function fe(){try{const{data:e}=await Ze.getRoutes();T.value=(e==null?void 0:e.map(et))??[]}catch(e){console.log(e)}}async function ve(){try{const{data:e}=await x.getClassStudentsProgress(Number(y.params.id),g.value,h.value),t={};for(const a of e.progress_data??[])t[a.student_id]||(t[a.student_id]={}),t[a.student_id][a.lesson_id]=a.student_progress;Z.value=t}catch(e){console.log(e)}}const Z=u({});function I(e,t){var a;return((a=Z.value[e])==null?void 0:a[t])??0}function ge(e){return e>=100?"bg-primary400":e>0?"bg-warning400":"bg-neutral100"}const U=u(!1),ee=u();async function te(e){try{U.value=!0;const{data:t}=await x.getClassStudents(e);ee.value=(t==null?void 0:t.map(st))??[]}catch(t){n.add({severity:"error",summary:t.response.data.error,life:2e3})}finally{U.value=!1}}Ae(async()=>{await A(),await fe(),await te(Number(y.params.id)),T.value.length>0&&(g.value=[T.value[0].id])}),Ue([g,h],async()=>{g.value.length==0||h.value.length==0||await ve()});function he(){j.require({message:d("pages.teacher.areYouSureDeleteClass"),header:d("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:d("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:d("pages.teacher.delete"),severity:"danger"},accept:()=>{ye(Number(y.params.id))}})}async function ye(e){try{const{data:t}=await x.deleteClass(e);K.go(-1),n.add({severity:"success",summary:t.message,life:2e3})}catch(t){n.add({severity:"error",summary:t.response.data.error,detail:t,life:2e3})}}function _e(e){j.require({message:d("pages.teacher.areYouSureExpelStudent"),header:d("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:d("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:d("pages.teacher.expel"),severity:"danger"},accept:()=>{be(e)}})}async function be(e){try{const{data:t}=await x.expelStudentFromClass(Number(y.params.id),e);await te(Number(y.params.id)),n.add({severity:"success",summary:t.message,life:2e3})}catch(t){n.add({severity:"error",summary:t.response.data.error,detail:t,life:2e3})}}const R=u(!1),V=u(!1),F=u(null);async function $e(){if(F.value){R.value=!0;try{await x.assignTeacherToClass(Number(y.params.id),F.value.teacher_id),await A()}catch(e){console.log(e)}finally{R.value=!1,V.value=!1}}}function we(){j.require({message:d("pages.school.confirmDeleteTeacher"),header:d("pages.school.confirmHeader"),icon:"pi pi-exclamation-triangle",rejectProps:{label:d("pages.school.confirmCancel"),severity:"secondary",outlined:!0},acceptProps:{label:d("pages.school.confirmDeleteBtn"),severity:"danger"},accept:()=>{xe()}})}async function xe(){try{const{data:e}=await x.assignTeacherToClass(Number(y.params.id));await A(),n.add({severity:"success",summary:e.message,life:2e3})}catch(e){n.add({severity:"error",summary:e.response.data.error,detail:e,life:2e3})}}const M=u([]);async function Ce(){const{data:e}=await at.getTeachers();M.value=e??[]}return(e,t)=>{const a=He,m=Xe,_=Ke,E=We,Se=Qe,p=Ye,q=rt,Te=nt,ke=Je,se=Oe,Ie=De,Ve=Ne,H=Fe;return i(),w(Ve,{class:"flex-grow flex flex-col gap-2"},{default:r(()=>{var ae,oe,le,ne,re;return[l("div",it,[l("div",ut,[l("div",ct,[l("div",dt,c((ae=C.value)==null?void 0:ae.name),1),l("div",pt,c(e.$t("pages.teacher.since"))+" "+c((oe=C.value)==null?void 0:oe.createdTime),1)]),o(a,{icon:"pi pi-hashtag",label:e.$t("pages.teacher.classCode"),severity:"info",onClick:t[0]||(t[0]=s=>G.value=!0)},null,8,["label"])]),l("div",mt,[l("div",ft,[l("span",vt,c(e.$t("pages.teacher.teacher")),1),O(" "+c((le=C.value)==null?void 0:le.creatorName),1)]),((ne=D(B))==null?void 0:ne.user_type)=="school_manager"?(i(),w(a,{key:0,icon:"pi pi-pencil",severity:"info",variant:"text",rounded:"",onClick:t[1]||(t[1]=s=>V.value=!0)})):L("",!0),((re=D(B))==null?void 0:re.user_type)=="school_manager"?(i(),w(a,{key:1,icon:"pi pi-trash",severity:"danger",variant:"text",rounded:"",onClick:we})):L("",!0)]),o(ke,{ref_key:"dt",ref:ce,filters:S.value,"onUpdate:filters":t[5]||(t[5]=s=>S.value=s),value:ee.value,dataKey:"id",loading:U.value,scrollable:"",globalFilterFields:["name","email"],class:"overflow-hidden w-full",paginator:"",rows:25,rowsPerPageOptions:[5,10,25],groupHeader:!0,showGridlines:""},{header:r(()=>[l("div",gt,[l("div",ht,[o(m,{class:"min-w-[220px]",options:T.value.map(s=>({label:s.name,value:s.id})),optionLabel:"label",invalid:g.value.length===0,optionValue:"value",display:"chip",modelValue:g.value,"onUpdate:modelValue":t[2]||(t[2]=s=>g.value=s),placeholder:e.$t("courses")},null,8,["options","invalid","modelValue","placeholder"]),o(m,{class:"min-w-[220px]",options:D(ie),optionLabel:s=>s,optionValue:s=>s,display:"chip",modelValue:h.value,"onUpdate:modelValue":t[3]||(t[3]=s=>h.value=s),placeholder:e.$t("lessonType"),invalid:h.value.length===0},{option:r(({option:s})=>[l("div",yt,[l("div",_t,c(s.charAt(0).toUpperCase()+s.slice(1)),1),l("div",{class:Y(["w-3 h-3 rounded-full mx-auto",X(s)])},null,2)])]),_:1},8,["options","optionLabel","optionValue","modelValue","placeholder","invalid"])]),o(Se,null,{default:r(()=>[o(_,null,{default:r(()=>t[10]||(t[10]=[l("i",{class:"pi pi-search"},null,-1)])),_:1}),o(E,{modelValue:S.value.global.value,"onUpdate:modelValue":t[4]||(t[4]=s=>S.value.global.value=s),placeholder:e.$t("pages.teacher.search")},null,8,["modelValue","placeholder"])]),_:1})])]),empty:r(()=>[O(c(e.$t("pages.teacher.noStudentsFound")),1)]),loading:r(()=>[O(c(e.$t("pages.teacher.loadingStudents")),1)]),default:r(()=>[o(Te,{type:"header"},{default:r(()=>[o(q,null,{default:r(()=>[o(p,{header:e.$t("lessons"),rowspan:2,colspan:1,frozen:!0,alignFrozen:"left"},null,8,["header"]),(i(!0),v(b,null,P(k.value,s=>(i(),v(b,{key:s.id},[Q.value[s.id]>0?(i(),w(p,{key:0,colspan:Q.value[s.id]},{header:r(()=>[l("div",bt,c(s.name),1)]),_:2},1032,["colspan"])):L("",!0)],64))),128)),o(p,{header:"",rowspan:2,colspan:2})]),_:1}),o(q,null,{default:r(()=>[(i(!0),v(b,null,P(k.value,s=>(i(),v(b,{key:s.id},[(i(!0),v(b,null,P(s.levels,f=>(i(),v(b,{key:f.id},[W.value[s.id][f.id]>0?(i(),w(p,{key:0,colspan:W.value[s.id][f.id]},{header:r(()=>[l("div",$t,c(f.name),1)]),_:2},1032,["colspan"])):L("",!0)],64))),128))],64))),128))]),_:1}),o(q,null,{default:r(()=>[o(p,{header:e.$t("pages.teacher.name"),frozen:!0,alignFrozen:"left",sortable:"",field:"name"},null,8,["header"]),(i(!0),v(b,null,P(z.value,s=>(i(),w(p,{key:s.lessonId,field:s.lessonId.toString()},{header:r(()=>[J(l("i",{class:Y(["pi pi-external-link mx-auto cursor-pointer hover:opacity-80 transition-opacity text-sm",X(s.lessonType)]),onClick:f=>D(K).push(`/teacher/class/${D(y).params.id}/lesson/${s.lessonId}`)},null,10,wt),[[H,{value:s.lessonName.toString()},void 0,{top:!0}]])]),_:2},1032,["field"]))),128)),o(p,{header:e.$t("pages.teacher.xp"),sortable:"",field:"xp",frozen:!0,alignFrozen:"right"},null,8,["header"]),o(p,{header:""})]),_:1})]),_:1}),o(p,{field:"name",sortable:"",frozen:!0,alignFrozen:"left"},{body:r(({data:s})=>[l("div",xt,[l("div",null,c(`${s.name.length>0?s.name:s.email}`),1),l("div",Ct,c(`Last visited: ${s.lastActivityTime.toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}`),1)])]),_:1}),(i(!0),v(b,null,P(z.value,s=>(i(),w(p,{key:s.lessonId,field:s.lessonId.toString()},{body:r(({data:f})=>[J((i(),v("div",{class:Y(["w-4 h-4 p-1 rounded-full mx-auto flex items-center justify-center text-white",ge(I(f.id,s.lessonId))])},[I(f.id,s.lessonId)>=100?(i(),v("i",St)):I(f.id,s.lessonId)>0?(i(),v("i",Tt)):L("",!0)],2)),[[H,{value:I(f.id,s.lessonId).toString()+"%"},void 0,{top:!0}]])]),_:2},1032,["field"]))),128)),o(p,{field:"xp",frozen:!0,alignFrozen:"right"},{body:r(({data:s})=>[l("div",kt,c(`${me(s.id)}/${pe.value}`),1)]),_:1}),o(p,{exportable:!1},{body:r(({data:s})=>[J(o(a,{icon:"pi pi-user-minus",rounded:"",variant:"text",severity:"danger",onClick:f=>_e(s.id)},null,8,["onClick"]),[[H,e.$t("pages.teacher.expelFromClass")]])]),_:1})]),_:1},8,["filters","value","loading"]),o(a,{icon:"pi pi-trash",label:e.$t("pages.teacher.removeClass"),severity:"danger",onClick:he,class:"self-end"},null,8,["label"])]),o(se,{visible:G.value,"onUpdate:visible":t[6]||(t[6]=s=>G.value=s),modal:"",header:e.$t("pages.teacher.classCode")},{default:r(()=>{var s;return[l("div",It,c((s=C.value)==null?void 0:s.code),1)]}),_:1},8,["visible","header"]),o(se,{visible:V.value,"onUpdate:visible":t[9]||(t[9]=s=>V.value=s),modal:"",header:e.$t("pages.school.assignTeacher"),closable:!1},{default:r(()=>[l("div",Vt,[o(Ie,{modelValue:F.value,"onUpdate:modelValue":t[7]||(t[7]=s=>F.value=s),options:M.value,"option-label":"email",placeholder:e.$t("pages.school.selectTeacher")},null,8,["modelValue","options","placeholder"])]),l("div",Ft,[o(a,{type:"button",label:e.$t("pages.school.cancel"),severity:"secondary",onClick:t[8]||(t[8]=s=>V.value=!1)},null,8,["label"]),o(a,{type:"button",label:e.$t("pages.school.assign"),onClick:$e,loading:R.value,disabled:R.value},null,8,["label","loading","disabled"])])]),_:1},8,["visible","header"])]}),_:1})}}});export{as as default};
