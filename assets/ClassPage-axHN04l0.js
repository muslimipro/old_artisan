import{T as Ye}from"./index-B2H5Bafp.js";import{s as Ke}from"./index-HPVAzmU3.js";import{B as Qe,s as Ie,b as Ve,a4 as Ze,a5 as Je,u as Pe,a as Ne,r as p,o as l,p as h,D as i,j as n,k as oe,t as d,h as o,c as m,l as A,F as P,q as C,i as x,w as Fe,L as De,Q as We,f as Xe,e as es,x as X,g as ss,E as ts,y as ee,n as fe,C as as,v as os,ay as ls}from"./index-CrrKimau.js";import{s as ns,a as rs}from"./index-CzVL6f0S.js";import{a as is,b as us}from"./index-Cc4fZZVN.js";import{s as cs}from"./index-DgmsQzkT.js";import{s as ds}from"./index-_C9UEwL7.js";import{s as ps}from"./index-rLSFooqB.js";import{R as ms,m as fs}from"./mapRouteFromDto-GFbZzc0z.js";import{A as vs}from"./lessonType-v5Tmr0TL.js";import{C as z,m as gs}from"./mapClassFromDto-AH29mFws.js";import{m as hs}from"./mapStudentFromDto-D4MSietx.js";import{S as ys}from"./schoolApi-BHD8vIk0.js";import{h as _s,z as ve,s as bs}from"./index-BXPBdHnN.js";import{s as ws}from"./index-sf2f6Ydm.js";import{s as $s}from"./index-DmzYo0zv.js";import{s as xs}from"./index-CKGdUHVN.js";import{s as Cs}from"./index-CVUgYmaA.js";import"./index-DxuAR6go.js";import"./index-CSMgnqNq.js";import"./index-VUifxjOs.js";import"./index-4_fBhWkb.js";import"./index-Dv3PXNVO.js";import"./index-D_2waQsa.js";import"./index-gprwKlQi.js";import"./index-DU7DOYFv.js";import"./index-B93GKCIf.js";import"./mapLessonFromDto-CG19vVOp.js";import"./mapUnitFromDto-DJ2zlrQL.js";import"./transformUnitDtosToPages-4blM3N0G.js";import"./index-Cxw2yqN5.js";var Ss=Qe.extend({name:"columngroup"}),ks={name:"BaseColumnGroup",extends:Ie,props:{type:{type:String,default:null}},style:Ss,provide:function(){return{$pcColumnGroup:this,$parentInstance:this}}},Ts={name:"ColumnGroup",extends:ks,inheritAttrs:!1,inject:["$columnGroups"],mounted:function(){var r;(r=this.$columnGroups)===null||r===void 0||r.add(this.$)},unmounted:function(){var r;(r=this.$columnGroups)===null||r===void 0||r.delete(this.$)},render:function(){return null}},Is={name:"Row",extends:Ie,inject:["$rows"],mounted:function(){var r;(r=this.$rows)===null||r===void 0||r.add(this.$)},unmounted:function(){var r;(r=this.$rows)===null||r===void 0||r.delete(this.$)},render:function(){return null}};const Vs={class:"flex flex-col gap-1"},Ps={class:"flex flex-col gap-2"},Ns={class:"font-extrabold"},Fs={class:"flex flex-col gap-1"},Ds={for:"new_password"},Ls={class:"my-0 flex flex-col gap-1"},js={class:"flex flex-col gap-1"},zs={for:"confirm_password"},Rs={class:"my-0 flex flex-col gap-1"},Ms={class:"flex justify-end gap-2"},Bs=Ve({__name:"ChangePasswordDialog",props:Ze({classId:{},selectedStudent:{}},{modelValue:{type:Boolean,required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(S){const r=Je(S,"modelValue"),k=S,y=Pe(),{t:N}=Ne(),u=p(!1),le=_s(ve.object({new_password:ve.string().min(8,{message:N("pages.login.min8chars")}).max(100,{message:N("pages.login.max100chars")}).refine(c=>/[a-z]/.test(c),{message:N("pages.login.mustHaveLowercase")}).refine(c=>/[A-Z]/.test(c),{message:N("pages.login.mustHaveUppercase")}).refine(c=>/[0-9]/.test(c),{message:N("pages.login.mustHaveNumber")}),confirm_password:ve.string()}).refine(c=>c.new_password===c.confirm_password,{message:N("pages.login.passMustMatch"),path:["confirm_password"]})),R=async c=>{if(k.selectedStudent!=null&&!u.value&&c.valid){u.value=!0;try{const{data:w}=await z.changeStudentPassword(k.classId,k.selectedStudent.id,c.states.new_password.value);y.add({severity:"success",summary:w.message,life:2e3}),r.value=!1}catch(w){y.add({severity:"error",summary:w.response.data.error,detail:w,life:2e3})}finally{u.value=!1}}};return(c,w)=>{const ne=Cs,$=xs,E=$s,_=ws,L=Fe,b=bs,T=De;return l(),h(T,{visible:r.value,"onUpdate:visible":w[1]||(w[1]=O=>r.value=O),modal:"",draggable:!1,class:"m-4 max-w-md",header:c.$t("pages.settings.changePassword")},{default:i(()=>{var O,F,j;return[n("div",Vs,[n("div",Ps,[n("div",null,[oe(d(c.$t("pages.settings.name"))+": ",1),n("span",Ns,d(((O=k.selectedStudent)==null?void 0:O.name)!=""?(F=k.selectedStudent)==null?void 0:F.name:(j=k.selectedStudent)==null?void 0:j.email),1)])]),o(ne),o(b,{resolver:x(le),onSubmit:R,class:"flex flex-col gap-4"},{default:i(M=>{var Q,D;return[n("div",Fs,[o(E,{variant:"on"},{default:i(()=>[o($,{id:"new_password",name:"new_password",feedback:!1,toggleMask:"",fluid:"",class:"w-full",autocomplete:"nope"}),n("label",Ds,d(c.$t("pages.settings.newPassword")),1)]),_:1}),(Q=M.new_password)!=null&&Q.invalid?(l(),h(_,{key:0,severity:"error",size:"small",variant:"simple"},{default:i(()=>[n("ul",Ls,[(l(!0),m(P,null,A(M.new_password.errors,(B,H)=>(l(),m("li",{key:H},d(B.message),1))),128))])]),_:2},1024)):C("",!0)]),n("div",js,[o(E,{variant:"on"},{default:i(()=>[o($,{id:"confirm_password",name:"confirm_password",feedback:!1,toggleMask:"",fluid:"",class:"w-full",autocomplete:"off"}),n("label",zs,d(c.$t("pages.settings.confirmPassword")),1)]),_:1}),(D=M.confirm_password)!=null&&D.invalid?(l(),h(_,{key:0,severity:"error",size:"small",variant:"simple"},{default:i(()=>[n("ul",Rs,[(l(!0),m(P,null,A(M.confirm_password.errors,(B,H)=>(l(),m("li",{key:H},d(B.message),1))),128))])]),_:2},1024)):C("",!0)]),n("div",Ms,[o(L,{type:"button",label:c.$t("pages.school.cancel"),variant:"text",onClick:w[0]||(w[0]=B=>r.value=!1)},null,8,["label"]),o(L,{type:"submit",label:c.$t("pages.settings.confirmPassword"),class:"w-fit",size:"small",loading:u.value,disabled:u.value},null,8,["label","loading","disabled"])])]}),_:1},8,["resolver"])])]}),_:1},8,["visible","header"])}}}),Us={class:"flex flex-col items-start px-8 pb-4 gap-4"},Gs={class:"flex items-center justify-between gap-2 w-full"},As={class:"flex flex-col gap-2"},Es={class:"text-3xl"},Os={class:"text-2xl"},Hs={class:"text-sm"},qs={class:"flex items-center self-end"},Ys={class:"text-xl"},Ks={class:"text-gray-500"},Qs={class:"flex items-center"},Zs={class:"flex-grow flex gap-2 items-center"},Js={class:"w-full text-center"},Ws={class:"w-full text-center"},Xs=["onClick"],et={class:"flex flex-col"},st={key:0,class:"pi pi-check",style:{"font-size":"10px"}},tt={key:1,class:"pi pi-ellipsis-h",style:{"font-size":"10px"}},at={class:"text-right"},ot={class:"flex justify-center text-[124px]"},lt={class:"flex justify-between items-center mb-8"},nt={class:"flex justify-end gap-2"},Mt=Ve({__name:"ClassPage",setup(S){const r=Pe(),k=We(),y=as(),N=os(),{t:u}=Ne(),le=p(),R=p();(()=>{R.value={global:{value:null,matchMode:ls.CONTAINS}}})();const w=()=>{var te,f,Y;const e=[u("pages.teacher.name"),u("pages.teacher.xp"),...D.value.map(V=>`${V.lessonName} (${V.lessonId})`)],s=(te=ue.value)==null?void 0:te.map(V=>{const K=[];K.push(`"${V.name.length>0?V.name:V.email}"`);const ae=H(V.id);K.push(`"${ae}/${B.value}"`);for(const pe of D.value){const G=q(V.id,pe.lessonId);K.push(`${G}%`)}return K.join(",")}).join(`
`),g=(((f=_.value)==null?void 0:f.schoolName)??"")+`
`+(((Y=_.value)==null?void 0:Y.name)??"")+`
`+e.join(",")+`
`+s,I=new Blob([g],{type:"text/csv;charset=utf-8;"}),W=URL.createObjectURL(I),U=document.createElement("a");U.setAttribute("href",W),U.setAttribute("download",`class_progress_${new Date().toISOString()}.csv`),document.body.appendChild(U),U.click(),document.body.removeChild(U)},ne=Xe(),{userInfo:$}=es(ne),E=p(!1),_=p(null),L=p([]),b=p([]),T=p(["learn","practice"]),O=["learn & practice","module","project"],F=p("learn & practice"),j=X(()=>{if(b.value.length==0||T.value.length==0)return[];const e=new Set(b.value),s=b.value.length>0,a=new Set(T.value),g=T.value.length>0&&T.value.length<vs.length;return L.value.filter(I=>!s||e.has(I.id)).map(I=>({...I,lessons:I.lessons.filter(W=>!g||a.has(W.lessonType))}))}),M=X(()=>{const e={};for(const s of j.value)e[s.id]=s.lessons.length;return e}),Q=X(()=>{const e={};for(const s of j.value){e[s.id]={};for(const a of s.levels)e[s.id][a.id]=0;for(const a of s.lessons)a.stage=="published"&&(e[s.id][a.levelId]=(e[s.id][a.levelId]??0)+1)}return e}),D=X(()=>{const e=[];for(const s of j.value)for(const a of s.levels)for(const g of s.lessons.filter(I=>I.levelId===a.id))g.stage=="published"&&e.push({routeId:s.id,levelId:a.id,lessonId:g.id,lessonType:g.lessonType,lessonName:g.name});return e}),B=X(()=>D.value.length);function H(e){let s=0;for(const a of D.value)q(e,a.lessonId)>=100&&(s+=1);return s}function ge(e){return e==="learn"?"bg-primary400":e==="practice"?"bg-purple400":e==="module"?"bg-warning400":"bg-blue400"}async function re(){var e;try{const{data:s}=await z.getClass(Number(y.params.id));_.value=gs(s),((e=$.value)==null?void 0:e.user_type)=="school_manager"&&(await Oe(),J.value=ce.value.find(a=>{var g;return a.teacher_id==((g=_.value)==null?void 0:g.creator)})??null)}catch(s){console.log(s)}}async function Le(){try{const{data:e}=await ms.getRoutes();L.value=(e==null?void 0:e.map(fs))??[]}catch(e){console.log(e)}}async function je(){try{const{data:e}=await z.getClassStudentsProgress(Number(y.params.id),b.value,T.value),s={};for(const a of e.progress_data??[])s[a.student_id]||(s[a.student_id]={}),s[a.student_id][a.lesson_id]=a.completed?100:a.student_progress;he.value=s}catch(e){console.log(e)}}const he=p({});function q(e,s){var a;return((a=he.value[e])==null?void 0:a[s])??0}function ze(e){return e>=100?"bg-primary400":e>0?"bg-warning400":"bg-neutral100"}const ie=p(!1),ue=p();async function ye(e){try{ie.value=!0;const{data:s}=await z.getClassStudents(e);ue.value=(s==null?void 0:s.map(hs))??[]}catch(s){r.add({severity:"error",summary:s.response.data.error,life:2e3})}finally{ie.value=!1}}ss(async()=>{await re(),await Le(),await ye(Number(y.params.id)),L.value.length>0&&(b.value=[L.value[0].id])}),ts([b,F],async()=>{F.value=="learn & practice"?T.value=["learn","practice"]:T.value=[F.value],!(b.value.length==0||T.value.length==0)&&await je()});function Re(){k.require({message:u("pages.teacher.areYouSureDeleteClass"),header:u("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:u("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:u("pages.teacher.delete"),severity:"danger"},accept:()=>{Me(Number(y.params.id))}})}async function Me(e){try{const{data:s}=await z.deleteClass(e);N.go(-1),r.add({severity:"success",summary:s.message,life:2e3})}catch(s){r.add({severity:"error",summary:s.response.data.error,detail:s,life:2e3})}}function Be(e){k.require({message:u("pages.teacher.areYouSureExpelStudent"),header:u("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:u("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:u("pages.teacher.expel"),severity:"danger"},accept:()=>{Ue(e)}})}async function Ue(e){try{const{data:s}=await z.expelStudentFromClass(Number(y.params.id),e);await ye(Number(y.params.id)),r.add({severity:"success",summary:s.message,life:2e3})}catch(s){r.add({severity:"error",summary:s.response.data.error,detail:s,life:2e3})}}const se=p(!1),Z=p(!1),J=p(null);async function Ge(){if(J.value){se.value=!0;try{await z.assignTeacherToClass(Number(y.params.id),J.value.teacher_id),await re()}catch(e){console.log(e)}finally{se.value=!1,Z.value=!1}}}function Ae(){k.require({message:u("pages.school.confirmDeleteTeacher"),header:u("pages.school.confirmHeader"),icon:"pi pi-exclamation-triangle",rejectProps:{label:u("pages.school.confirmCancel"),severity:"secondary",outlined:!0},acceptProps:{label:u("pages.school.confirmDeleteBtn"),severity:"danger"},accept:()=>{Ee()}})}async function Ee(){try{const{data:e}=await z.assignTeacherToClass(Number(y.params.id));await re(),r.add({severity:"success",summary:e.message,life:2e3})}catch(e){r.add({severity:"error",summary:e.response.data.error,detail:e,life:2e3})}}const ce=p([]);async function Oe(){const{data:e}=await ys.getTeachers();ce.value=e??[]}const de=p(!1),_e=p(null);function He(e){de.value=!0,_e.value=e}return(e,s)=>{const a=Fe,g=ps,I=ds,W=is,U=cs,te=us,f=ns,Y=Is,V=Ts,K=rs,ae=De,pe=Ke,G=Ye;return l(),h(pe,{class:"flex-grow flex flex-col gap-2"},{default:i(()=>{var be,we,$e,xe,Ce,Se,ke,Te;return[n("div",Us,[n("div",Gs,[n("div",As,[n("div",Es,d((be=_.value)==null?void 0:be.schoolName),1),n("div",Os,d((we=_.value)==null?void 0:we.name),1),n("div",Hs,d(e.$t("pages.teacher.since"))+" "+d(($e=_.value)==null?void 0:$e.createdTime),1)]),["teacher","school_manager"].includes(((xe=x($))==null?void 0:xe.user_type)??"")?(l(),h(a,{key:0,icon:"pi pi-hashtag",label:e.$t("pages.teacher.classCode"),severity:"info",onClick:s[0]||(s[0]=t=>E.value=!0)},null,8,["label"])):C("",!0)]),n("div",qs,[n("div",Ys,[n("span",Ks,d(e.$t("pages.teacher.teacher")),1),oe(" "+d((Ce=_.value)==null?void 0:Ce.creatorName),1)]),((Se=x($))==null?void 0:Se.user_type)=="school_manager"?(l(),h(a,{key:0,icon:"pi pi-pencil",severity:"info",variant:"text",rounded:"",onClick:s[1]||(s[1]=t=>Z.value=!0)})):C("",!0),((ke=x($))==null?void 0:ke.user_type)=="school_manager"?(l(),h(a,{key:1,icon:"pi pi-trash",severity:"danger",variant:"text",rounded:"",onClick:Ae})):C("",!0)]),o(K,{ref_key:"dt",ref:le,filters:R.value,"onUpdate:filters":s[5]||(s[5]=t=>R.value=t),value:ue.value,dataKey:"id",loading:ie.value,scrollable:"",globalFilterFields:["name","email"],class:"overflow-hidden w-full",paginator:"",rows:25,rowsPerPageOptions:[5,10,25],groupHeader:!0,showGridlines:""},{header:i(()=>[n("div",Qs,[n("div",Zs,[o(g,{modelValue:F.value,"onUpdate:modelValue":s[2]||(s[2]=t=>F.value=t),options:O,optionLabel:t=>t,optionValue:t=>t,placeholder:e.$t("lessonType"),invalid:!F.value,class:"min-w-[220px]"},null,8,["modelValue","optionLabel","optionValue","placeholder","invalid"]),o(I,{class:"min-w-[220px]",options:L.value.map(t=>({label:t.name,value:t.id})),optionLabel:"label",invalid:b.value.length===0,optionValue:"value",display:"chip",modelValue:b.value,"onUpdate:modelValue":s[3]||(s[3]=t=>b.value=t),placeholder:e.$t("courses")},null,8,["options","invalid","modelValue","placeholder"])]),o(a,{label:e.$t("export"),icon:"pi pi-upload",severity:"info",variant:"outlined",class:"mr-2",onClick:w},null,8,["label"]),o(te,null,{default:i(()=>[o(W,null,{default:i(()=>s[11]||(s[11]=[n("i",{class:"pi pi-search"},null,-1)])),_:1}),o(U,{modelValue:R.value.global.value,"onUpdate:modelValue":s[4]||(s[4]=t=>R.value.global.value=t),placeholder:e.$t("pages.teacher.search")},null,8,["modelValue","placeholder"])]),_:1})])]),empty:i(()=>[oe(d(e.$t("pages.teacher.noStudentsFound")),1)]),loading:i(()=>[oe(d(e.$t("pages.teacher.loadingStudents")),1)]),default:i(()=>[o(V,{type:"header"},{default:i(()=>[o(Y,null,{default:i(()=>[o(f,{header:e.$t("lessons"),rowspan:2,colspan:1,frozen:!0,alignFrozen:"left"},null,8,["header"]),(l(!0),m(P,null,A(j.value,t=>(l(),m(P,{key:t.id},[M.value[t.id]>0?(l(),h(f,{key:0,colspan:M.value[t.id]},{header:i(()=>[n("div",Js,d(t.name),1)]),_:2},1032,["colspan"])):C("",!0)],64))),128)),o(f,{header:"",rowspan:2,colspan:2})]),_:1}),o(Y,null,{default:i(()=>[(l(!0),m(P,null,A(j.value,t=>(l(),m(P,{key:t.id},[(l(!0),m(P,null,A(t.levels,v=>(l(),m(P,{key:v.id},[Q.value[t.id][v.id]>0?(l(),h(f,{key:0,colspan:Q.value[t.id][v.id]},{header:i(()=>[n("div",Ws,d(v.name),1)]),_:2},1032,["colspan"])):C("",!0)],64))),128))],64))),128))]),_:1}),o(Y,null,{default:i(()=>[o(f,{header:e.$t("pages.teacher.name"),frozen:!0,alignFrozen:"left",sortable:"",field:"name"},null,8,["header"]),(l(!0),m(P,null,A(D.value,t=>(l(),h(f,{key:t.lessonId,field:t.lessonId.toString()},{header:i(()=>{var v;return[["super_admin","admin-viewer","school_manager","teacher"].includes(((v=x($))==null?void 0:v.user_type)??"")?ee((l(),m("i",{key:0,class:fe(["pi pi-external-link mx-auto cursor-pointer hover:opacity-80 transition-opacity text-sm",ge(t.lessonType)]),onClick:me=>x(N).push(`/teacher/class/${x(y).params.id}/lesson/${t.lessonId}`)},null,10,Xs)),[[G,{value:t.lessonName.toString()},void 0,{top:!0}]]):ee((l(),m("div",{key:1,class:fe(["w-3 h-3 rounded-full mx-auto",ge(t.lessonType)])},null,2)),[[G,{value:t.lessonName.toString()},void 0,{top:!0}]])]}),_:2},1032,["field"]))),128)),o(f,{header:e.$t("pages.teacher.xp"),field:"xp",frozen:!0,alignFrozen:"right"},null,8,["header"]),o(f,{header:""})]),_:1})]),_:1}),o(f,{field:"name",sortable:"",frozen:!0,alignFrozen:"left"},{body:i(({data:t})=>[n("div",et,[n("div",null,d(`${t.name.length>0?t.name:t.email}`),1)])]),_:1}),(l(!0),m(P,null,A(D.value,t=>(l(),h(f,{key:t.lessonId,field:t.lessonId.toString()},{body:i(({data:v})=>[ee((l(),m("div",{class:fe(["w-4 h-4 p-1 rounded-full mx-auto flex items-center justify-center text-white",ze(q(v.id,t.lessonId))])},[q(v.id,t.lessonId)>=100?(l(),m("i",st)):q(v.id,t.lessonId)>0?(l(),m("i",tt)):C("",!0)],2)),[[G,{value:q(v.id,t.lessonId).toString()+"%"},void 0,{top:!0}]])]),_:2},1032,["field"]))),128)),o(f,{field:"xp",frozen:!0,alignFrozen:"right"},{body:i(({data:t})=>[n("div",at,d(`${H(t.id)}/${B.value}`),1)]),_:1}),o(f,{exportable:!1},{body:i(({data:t})=>{var v,me;return[["teacher","school_manager"].includes(((v=x($))==null?void 0:v.user_type)??"")?ee((l(),h(a,{key:0,icon:"pi pi-key",rounded:"",variant:"text",severity:"warn",onClick:qe=>He(t)},null,8,["onClick"])),[[G,e.$t("pages.settings.changePassword")]]):C("",!0),["teacher","school_manager"].includes(((me=x($))==null?void 0:me.user_type)??"")?ee((l(),h(a,{key:1,icon:"pi pi-user-minus",rounded:"",variant:"text",severity:"danger",onClick:qe=>Be(t.id)},null,8,["onClick"])),[[G,e.$t("pages.teacher.expelFromClass")]]):C("",!0)]}),_:1})]),_:1},8,["filters","value","loading"]),["teacher","school_manager"].includes(((Te=x($))==null?void 0:Te.user_type)??"")?(l(),h(a,{key:0,icon:"pi pi-trash",label:e.$t("pages.teacher.removeClass"),severity:"danger",onClick:Re,class:"self-end"},null,8,["label"])):C("",!0)]),o(ae,{visible:E.value,"onUpdate:visible":s[6]||(s[6]=t=>E.value=t),modal:"",header:e.$t("pages.teacher.classCode")},{default:i(()=>{var t;return[n("div",ot,d((t=_.value)==null?void 0:t.code),1)]}),_:1},8,["visible","header"]),o(ae,{visible:Z.value,"onUpdate:visible":s[9]||(s[9]=t=>Z.value=t),modal:"",header:e.$t("pages.school.assignTeacher"),closable:!1},{default:i(()=>[n("div",lt,[o(g,{modelValue:J.value,"onUpdate:modelValue":s[7]||(s[7]=t=>J.value=t),options:ce.value,"option-label":"email",placeholder:e.$t("pages.school.selectTeacher")},null,8,["modelValue","options","placeholder"])]),n("div",nt,[o(a,{type:"button",label:e.$t("pages.school.cancel"),severity:"secondary",onClick:s[8]||(s[8]=t=>Z.value=!1)},null,8,["label"]),o(a,{type:"button",label:e.$t("pages.school.assign"),onClick:Ge,loading:se.value,disabled:se.value},null,8,["label","loading","disabled"])])]),_:1},8,["visible","header"]),o(Bs,{"model-value":de.value,"onUpdate:modelValue":s[10]||(s[10]=t=>de.value=t),classId:Number(x(y).params.id),"selected-student":_e.value},null,8,["model-value","classId","selected-student"])]}),_:1})}}});export{Mt as default};
